{extend name='extra@admin/content' /}

{block name="style"}
<link rel="stylesheet" href="//cdn.datatables.net/plug-ins/28e7751dbec/integration/bootstrap/3/dataTables.bootstrap.css">
<link href="https://cdn.bootcss.com/iCheck/1.0.2/skins/minimal/minimal.css" rel="stylesheet">
{/block}

{block name="button"}

{/block}

{block name="content"}

<main class="main">
  <div class="mt_box">
    <div class="inquiry_box">
      <form class="form-inline">
        <input type="text" id="order_code" class="form-control" placeholder="订单编号">
        <input type="text" id="pr_code" class="form-control" placeholder="采购单编号">
        <input type="text" class="form-control" placeholder="需求部门">
        <input type="text" class="form-control" placeholder="需求人员">
        <input type="text" class="form-control" placeholder="交期">
        <button type="button" id="searchVal" class="btn btn-info">查询</button>
      </form>
    </div>
    <div class="order_table">
      <div class="pb_15">
        <button type="button" id="remove_btn" class="btn btn-danger">删除</button>
      </div>
      <div class="order_box">
        <table id="example" class="display table table-bordered" cellspacing="0" width="100%">
          <thead>
          <tr>
            <th>
              <input type="checkbox" class="all">
            </th>
            <th>订单编号</th>
            <th>请购单编号</th>
            <th>请购日期</th>
            <th>下单日期</th>
            <th>供应商名称</th>
            <th>执行情况</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody>
            <tr>
              <td class="plr_18"></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td><a class="detail" data-open="{:url('admin/order/detailed')}">详情</a></td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

{/block}

{block name="script"}

<script src="/static/admin/order/index.js"></script>

<script>
  var orderTables;
  require(["jquery.dataTables","icheck"],function(){
    require(["dataTables.bootstrap"],function(){
      $(document).ready(function(){
        initPage();
        initEvent();
      });
    })

    function initPage(){
      //icheck
      $('input').iCheck({
        checkboxClass: 'icheckbox_minimal',
        radioClass: 'iradio_minimal',
        increaseArea: '20%' // optional
      });

      // datatable
      orderTables = $('#example').DataTable({
        //"paging": false, //设置是否分页
        "info": false,  //去除左下角的信息
        "lengthChange": false, //是否允许用户改变表格每页显示的记录数
        "ordering": false, //是否允许Datatables开启排序
        "searching": false,  //是否允许Datatables开启本地搜索
        "processing": true,
        //"serverSide": true,
        "ajax": {
          "url": '{:url("Order/getOrderList")}',
          "type": "POST",
          "data": function (parameter) {
            //添加额外的参数传给服务器
            parameter.order_code = $("#order_code").val();
            parameter.pr_code = $("#pr_code").val();
            //parameter.order_code = $("#order_code").val();
            //parameter.order_code = $("#order_code").val();
          }
        },
        "columnDefs": [
          {
            "targets": 0,
            "data": null,
            "render": function (data) {
              return '<input type="checkbox" class="check" value="' + data + '">';
            }
          },
          {
            "targets": 7,
            "render": function (data) {
              var url = '{:url(\'order/detailed\')}?id='+data;//data
              return '<a class="detail" data-open="' + url + '">详情</a>';
              //return url;
            }
          }
        ],
        "pageLength": 10,
        language: {
          "oPaginate": {
            "sFirst": "首页",
            "sPrevious": "上页",
            "sNext": "下页",
            "sLast": "末页"
          },
        },
        "columns": [
          { "data": "checked" },
          { "data": "order_code" },
          { "data": "pr_code" },
          { "data": "pr_date" },
          { "data": "create_at" },
          { "data": "sup_name" },
          { "data": "status" },
          { "data": "detail" },
        ],
        "drawCallback": function( settings ) {

        }
      });

      // tr点击选中事件
      $('#example tbody').on( 'click', 'tr', function () {
        $(this).toggleClass('selected');
      } );
      // 立即同步ERP 点击事件
      $('#synchronization_btn').click( function () {
        alert( orderTables.rows('.selected').data().length +' row(s) selected' );
      });
      //删除物料
      $('#remove_btn').click( function () {
        orderTables.rows('.selected').remove().draw( false );
      } );
    }

    function initEvent(){
      // 点击详情
      $(".detail").click(function(e){
        // e.stopPropagation();
      });

      var checkAll =$('input.all');
      var checkboxs =$('input.check');

      checkAll.on('ifChecked ifUnchecked',function(event){
        if(event.type == 'ifChecked'){
          checkboxs.iCheck('check');
        }else{
          checkboxs.iCheck('uncheck');
        }
      });

      checkboxs.on('ifChanged',function(event){
        if(checkboxs.filter(':checked').length == checkboxs.length){
          checkAll.prop('checked',true);
        }else{
          checkAll.prop('checked',false);
        }
        checkAll.iCheck('update');
      })
    }
    $("#searchVal").on('click', function () {
      //console.log(orderTables);
      orderTables.ajax.reload();
    })

  })


</script>


{/block}